# 運作

ARC 的運作核心是「引用計數」(Reference Counting)。它只對類別 (class) 的實例有效，因為結構 (struct) 和列舉 (enum) 是實值型別，不會被引用。

整個運作流程可以想像成這樣：

1. **物件的誕生 (Initialization)**

   - 當你建立一個類別的新實例時（例如 `let user = User()`），系統會分配一塊記憶體來儲存這個物件的資訊。

   - 同時，ARC 會在這個物件內部設定一個稱為「引用計數器」(retain count) 的東西，並將其初始值設為 **1**。

   - 這個 `user` 常數現在是對 `User` 物件的一個**強引用** (strong reference)。[\[1\]](https://app.heptabase.com/f3c4fc0d-fe07-4b10-932c-6f968c1f5ab0/card/de0cd134-62dd-4125-9b6e-3c7748b16335#3b03ef57-a114-4a7e-985e-1986687039f8,6eba1d72-5b00-4cec-805f-3d2b5eef3c67)

2. **增加引用 (Assigning to another variable)**

   - 當你將這個物件實例賦值給另一個變數、常數或屬性時，就會建立一個新的強引用。

   - 例如：`let anotherUser = user`。

   - 每增加一個強引用，ARC 就會自動將該物件的引用計數器 **\+1**。

   - 現在，`User` 物件的引用計數變為 **2**。

3. **減少引用 (Reference goes out of scope)**

   - 當一個指向物件的強引用被銷毀時（例如，一個變數離開了它的作用域，或者你手動將它設為 `nil`），ARC 就會將該物件的引用計數器 **\-1**。

   - 假設 `anotherUser` 變數離開了作用域，引用計數會從 2 降回 1。

   - 假設接著 `user` 變數也離開了作用域，引用計數會從 1 降為 **0**。

4. **物件的死亡 (Deinitialization)**

   - ARC 會持續監控所有物件的引用計數。

   - 一旦某個物件的引用計數變為 **0**，代表再也沒有任何強引用指向它了。

   - ARC 就會立即銷毀該物件，並釋放它所佔用的記憶體。在釋放之前，該物件的 `deinit` 方法會被呼叫。

**簡單來說，ARC 就是一個自動化的管理員：**

- **編譯時期**：它會分析你的程式碼，在你建立強引用、銷毀強引用的地方，自動插入對應的 `retain` (增加計數) 和 `release` (減少計數) 的底層程式碼。[\[2\]](https://app.heptabase.com/f3c4fc0d-fe07-4b10-932c-6f968c1f5ab0/card/de0cd134-62dd-4125-9b6e-3c7748b16335#6db09726-74c6-4882-ad12-38a51ac0b306,1d6921ae-9d2b-479b-b2dd-8ff82dfc6248)[\[3\]](https://app.heptabase.com/f3c4fc0d-fe07-4b10-932c-6f968c1f5ab0/card/de0cd134-62dd-4125-9b6e-3c7748b16335#a480110d-b7b9-4850-b329-da924030e0a2,5f4aed6c-8ac0-49e4-9608-0449ad541e6d,60df89d5-a380-4a35-95dc-3e6ffc6a3a75,782bf724-8f72-4bf5-bda7-9b6f53b74fd6)

- **執行時期**：這些被插入的程式碼會忠實地維護每個物件的引用計數。一旦計數歸零，物件就會被立即回收。

這個機制完美地解釋了為什麼需要 `weak` 和 `unowned` 引用：如果兩個物件互相持有對方的強引用（例如，一個 `User` 有一個 `CreditCard`，而 `CreditCard` 又有一個 `owner` 指回 `User`），它們各自的引用計數就永遠不會降到 0，即使外界已經沒有任何變數指向它們了。這就會造成「強引用循環」，也就是記憶體洩漏。[\[1\]](https://app.heptabase.com/f3c4fc0d-fe07-4b10-932c-6f968c1f5ab0/card/de0cd134-62dd-4125-9b6e-3c7748b16335#3b03ef57-a114-4a7e-985e-1986687039f8,6eba1d72-5b00-4cec-805f-3d2b5eef3c67)